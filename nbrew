#!/usr/bin/env bash
#
# nbrew - Homebrew-style wrapper for Nix using flake.nix
#

set -euo pipefail

# Configuration
NBREW_CONFIG_DIR="${NBREW_CONFIG_DIR:-$HOME/.config/nix}"
GLOBAL_FLAKE="$NBREW_CONFIG_DIR/flake.nix"
LOCAL_FLAKE="./flake.nix"
NIX_FLAGS=(--extra-experimental-features nix-command --extra-experimental-features flakes)

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helpers
info() { echo -e "${BLUE}==>>${NC} $*"; }
success() { echo -e "${GREEN}==>>${NC} $*"; }
warn() { echo -e "${YELLOW}Warning:${NC} $*"; }
error() { echo -e "${RED}Error:${NC} $*" >&2; }
die() { error "$@"; exit 1; }

# Check dependencies
check_deps() {
    command -v nix >/dev/null 2>&1 || die "nix is not installed"
    command -v jq >/dev/null 2>&1 || die "jq is not installed (required for JSON parsing)"
}

# Get the flake.nix path (local takes precedence over global)
get_flake() {
    if [[ -f "$LOCAL_FLAKE" ]]; then
        echo "$LOCAL_FLAKE"
    elif [[ -f "$GLOBAL_FLAKE" ]]; then
        echo "$GLOBAL_FLAKE"
    else
        echo "$GLOBAL_FLAKE"
    fi
}

# Get flake directory
get_flake_dir() {
    dirname "$(get_flake)"
}

# Parse packages from flake.nix (profile packages)
get_packages_from_flake() {
    local flake="$1"
    if [[ -f "$flake" ]]; then
        # Extract package names from the packages section (format: "name = pkgs.name;")
        sed -n '/# \[nbrew:packages\]/,/# \[\/nbrew:packages\]/p' "$flake" 2>/dev/null | \
            grep -E '^\s+[a-zA-Z0-9_-]+ = pkgs\.' | \
            sed 's/^[[:space:]]*\([a-zA-Z0-9_-]*\) = pkgs\..*/\1/' | \
            sort -u
    fi
}

# Parse dev packages from flake.nix
get_dev_packages_from_flake() {
    local flake="$1"
    if [[ -f "$flake" ]]; then
        # Extract package names from buildInputs
        sed -n '/# \[nbrew:devShell\]/,/# \[\/nbrew:devShell\]/p' "$flake" 2>/dev/null | \
            grep -E '^\s+pkgs\.' | \
            sed 's/.*pkgs\.\([a-zA-Z0-9_-]*\).*/\1/' | \
            sort -u
    fi
}

# Get list of installed packages from nix profile
get_installed_packages() {
    nix "${NIX_FLAGS[@]}" profile list --json 2>/dev/null | \
        jq -r '.elements | keys[]' 2>/dev/null || true
}

# Install a package and track in flake.nix
cmd_install() {
    local pkg="$1"
    [[ -z "$pkg" ]] && die "Usage: nbrew install <package>"

    info "Installing $pkg..."
    nix "${NIX_FLAGS[@]}" profile install "nixpkgs#$pkg"
    success "Installed $pkg"

    # Update flake.nix (creates if doesn't exist)
    cmd_bundle_dump
}

# Uninstall a package
cmd_uninstall() {
    local pkg="$1"
    [[ -z "$pkg" ]] && die "Usage: nbrew uninstall <package>"

    info "Uninstalling $pkg..."

    # Check if installed
    local installed
    installed=$(get_installed_packages)
    if ! echo "$installed" | grep -qx "$pkg"; then
        die "Package $pkg is not installed"
    fi

    nix "${NIX_FLAGS[@]}" profile remove "$pkg"
    success "Uninstalled $pkg"

    # Update flake.nix
    cmd_bundle_dump
}

# Search for packages
cmd_search() {
    local query="$1"
    [[ -z "$query" ]] && die "Usage: nbrew search <query>"

    info "Searching for $query..."
    nix "${NIX_FLAGS[@]}" search nixpkgs "$query"
}

# List installed packages
cmd_list() {
    info "Installed packages:"
    nix "${NIX_FLAGS[@]}" profile list
}

# Upgrade all packages
cmd_upgrade() {
    local flake_dir
    flake_dir=$(get_flake_dir)
    local flake="$flake_dir/flake.nix"

    # Update flake.lock if flake.nix exists
    if [[ -f "$flake" ]]; then
        info "Updating flake.lock..."
        nix "${NIX_FLAGS[@]}" flake update "$flake_dir"
    fi

    info "Upgrading all packages..."
    nix "${NIX_FLAGS[@]}" profile upgrade '.*'
    success "All packages upgraded"

    # Update flake.nix
    cmd_bundle_dump
}

# Garbage collect old generations
cmd_gc() {
    info "Running garbage collection..."
    nix-collect-garbage -d
    success "Garbage collection complete"
}

# Generate flake.nix content
generate_flake() {
    local -a packages=("$@")
    local pkg_entries=""
    local shell_entries=""

    for pkg in "${packages[@]}"; do
        [[ -z "$pkg" ]] && continue
        pkg_entries+="          $pkg = pkgs.$pkg;"$'\n'
        shell_entries+="              pkgs.$pkg"$'\n'
    done

    cat << EOF
{
  description = "nbrew managed packages";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
  };

  outputs = { self, nixpkgs }:
    let
      systems = [ "x86_64-linux" "aarch64-linux" "x86_64-darwin" "aarch64-darwin" ];
      forAllSystems = f: nixpkgs.lib.genAttrs systems (system: f system);
    in {
      # Profile packages (nbrew bundle)
      packages = forAllSystems (system:
        let pkgs = nixpkgs.legacyPackages.\${system};
        in {
          # [nbrew:packages]
${pkg_entries}          # [/nbrew:packages]
        });

      # Development shell (nbrew shell)
      devShells = forAllSystems (system:
        let pkgs = nixpkgs.legacyPackages.\${system};
        in {
          default = pkgs.mkShell {
            buildInputs = [
              # [nbrew:devShell]
${shell_entries}              # [/nbrew:devShell]
            ];
          };
        });
    };
}
EOF
}

# Bundle sync - sync installed packages with flake.nix
cmd_bundle_install() {
    local flake_dir
    flake_dir=$(get_flake_dir)
    local flake="$flake_dir/flake.nix"

    if [[ ! -f "$flake" ]]; then
        die "No flake.nix found at $flake. Run 'nbrew install <package>' to create one."
    fi

    info "Syncing packages with $flake..."

    local packages
    packages=$(get_packages_from_flake "$flake")

    local installed
    installed=$(get_installed_packages)

    # Find packages to install (in flake but not installed)
    local to_install=()
    for pkg in $packages; do
        if ! echo "$installed" | grep -qx "$pkg"; then
            to_install+=("$pkg")
        fi
    done

    # Find packages to remove (installed but not in flake)
    local to_remove=()
    for pkg in $installed; do
        if ! echo "$packages" | grep -qx "$pkg"; then
            to_remove+=("$pkg")
        fi
    done

    if [[ ${#to_install[@]} -eq 0 ]] && [[ ${#to_remove[@]} -eq 0 ]]; then
        success "Already in sync"
        return 0
    fi

    # Install missing packages
    for pkg in "${to_install[@]}"; do
        info "Installing $pkg..."
        nix "${NIX_FLAGS[@]}" profile install "nixpkgs#$pkg" || warn "Failed to install $pkg"
    done

    # Remove extra packages
    for pkg in "${to_remove[@]}"; do
        info "Removing $pkg..."
        nix "${NIX_FLAGS[@]}" profile remove "$pkg" || warn "Failed to remove $pkg"
    done

    success "Sync complete"
}

# Bundle dump - export installed packages to flake.nix
cmd_bundle_dump() {
    local flake_dir
    flake_dir=$(get_flake_dir)
    local flake="$flake_dir/flake.nix"

    info "Dumping installed packages to $flake..."

    # Ensure directory exists
    mkdir -p "$flake_dir"

    # Get installed packages
    local -a packages=()
    while IFS= read -r pkg; do
        [[ -n "$pkg" ]] && packages+=("$pkg")
    done < <(get_installed_packages)

    if [[ ${#packages[@]} -eq 0 ]]; then
        warn "No packages installed"
    fi

    # Generate and write flake.nix
    generate_flake "${packages[@]}" > "$flake"

    success "Dumped ${#packages[@]} package(s) to $flake"
    info "Run 'cd $flake_dir && git init && git add flake.nix' to track with git"
}

# Enter dev shell
cmd_shell() {
    local flake_dir
    flake_dir=$(get_flake_dir)
    local flake="$flake_dir/flake.nix"

    if [[ ! -f "$flake" ]]; then
        die "No flake.nix found at $flake. Run 'nbrew add <package>' to create one."
    fi

    info "Entering dev shell..."
    nix "${NIX_FLAGS[@]}" develop "$flake_dir" --impure
}


# Show help
cmd_help() {
    cat << 'EOF'
nbrew - Homebrew-style wrapper for Nix (using flake.nix)

USAGE:
    nbrew <command> [args]

BASIC COMMANDS:
    install <pkg>     Install a package (tracked in flake.nix)
    uninstall <pkg>   Uninstall a package
    search <query>    Search for packages
    list              List installed packages
    upgrade           Upgrade all packages

SYNC COMMANDS:
    bundle            Sync installed packages with flake.nix

ENVIRONMENT COMMANDS:
    shell             Enter dev shell from flake.nix
    gc                Garbage collect old generations

CONFIG FILES:
    Global: ~/.config/nix/flake.nix
    Local:  ./flake.nix (takes precedence if exists)

EXAMPLES:
    nbrew install ripgrep      # Install package
    nbrew bundle               # Install from flake.nix (on new machine)
    nbrew shell                # Enter dev shell

EOF
}

# Main entry point
main() {
    check_deps

    local cmd="${1:-help}"
    shift || true

    case "$cmd" in
        install|add)
            cmd_install "${1:-}"
            ;;
        uninstall|remove)
            cmd_uninstall "${1:-}"
            ;;
        search)
            cmd_search "${1:-}"
            ;;
        list|ls)
            cmd_list
            ;;
        upgrade)
            cmd_upgrade
            ;;
        gc)
            cmd_gc
            ;;
        shell|dev)
            cmd_shell
            ;;
        bundle)
            local subcmd="${1:-install}"
            cmd_bundle_install
            ;;
        help|--help|-h)
            cmd_help
            ;;
        *)
            die "Unknown command: $cmd. Run 'nbrew help' for usage."
            ;;
    esac
}

main "$@"
